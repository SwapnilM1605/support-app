<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Knowledge Base</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
      .team-section { margin-bottom: 30px; }
      .category-section { margin-left: 20px; margin-bottom: 15px; }
      .upload-form { margin-top: 10px; }
      .document-list { margin-top: 10px; }
      .document-item { margin-bottom: 5px; }
      .edit-mode { display: none; }
      .view-mode { display: block; }
      .editing .edit-mode { display: block; }
      .editing .view-mode { display: none; }
      .doc-content { white-space: pre-wrap; max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; }
    </style>
  </head>
  <body class="p-4">
    <div class="container">
      <h2>Knowledge Base</h2>
      <a href="{{ url_for('dashboard') }}" class="btn btn-secondary mb-3">Back to Dashboard</a>
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, msg in messages %}
            <div class="alert alert-{{ category }}">{{ msg }}</div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <h4>Teams and Categories</h4>
      {% for team in teams %}
        <div class="team-section">
          <h5>{{ team }} ({{ team_emails[team] }})</h5>
          <p>{{ team_descriptions[team] or 'No description' }}</p>
          {% for category in category_lookup[team] %}
            <div class="category-section">
              <h6>{{ category }}</h6>
              <p>{{ category_descriptions[team][category] or 'No description' }}</p>
              <form action="{{ url_for('upload_document', team_name=team, category_name=category) }}" method="post" enctype="multipart/form-data" class="upload-form">
                <div class="form-group">
                  <input type="file" name="file" class="form-control-file" accept=".txt,.pdf,.doc,.docx" required>
                </div>
                <button type="submit" class="btn btn-primary btn-sm">Upload Document</button>
              </form>
              <div class="document-list">
                <h6>Documents</h6>
                {% set documents = get_documents(team, category) %}
                {% if documents %}
                  <ul>
                    {% for doc in documents %}
                      <li class="document-item doc-row" data-docid="{{ doc.id }}">
                        <a href="{{ url_for('download_document', doc_id=doc.id) }}">{{ doc.filename }}</a>
                        (Uploaded: {{ doc.uploaded_at.strftime('%Y-%m-%d %H:%M') }})
                        <form action="{{ url_for('delete_document', doc_id=doc.id) }}" method="post" style="display:inline;">
                          <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                        </form>
                        <button class="btn btn-primary btn-sm edit-doc-btn">Edit Content</button>
                        <div class="doc-content view-mode">{{ doc.content|truncate(200) }}</div>
                        <div class="edit-mode">
                          <textarea class="form-control doc-content-textarea" rows="10">{{ doc.content }}</textarea>
                          <button class="btn btn-success btn-sm save-doc-btn">Save</button>
                          <button class="btn btn-secondary btn-sm cancel-doc-btn">Cancel</button>
                        </div>
                      </li>
                    {% endfor %}
                  </ul>
                {% else %}
                  <p>No documents available.</p>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
      {% endfor %}
    </div>

    <script>
      $(document).ready(function() {
        // Document edit/save functionality
        $(document).on('click', '.edit-doc-btn', function() {
          const row = $(this).closest('.doc-row');
          row.addClass('editing');
        });

        $(document).on('click', '.cancel-doc-btn', function() {
          const row = $(this).closest('.doc-row');
          row.removeClass('editing');
        });

        $(document).on('click', '.save-doc-btn', function() {
          const row = $(this).closest('.doc-row');
          const docId = row.data('docid');
          const content = row.find('.doc-content-textarea').val();

          $.ajax({
            url: '/knowledge/update/' + docId,
            method: 'POST',
            data: {
              content: content
            },
            success: function(response) {
              location.reload(); // Refresh to show changes
            },
            error: function(xhr) {
              alert('Error updating document: ' + xhr.responseJSON?.error || xhr.responseText);
            }
          });
        });
      });
    </script>
  </body>
</html>
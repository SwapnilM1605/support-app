<!-- templates/categories.html file -->
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Manage Teams & Categories</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
      .edit-mode { display: none; }
      .view-mode { display: block; }
      .editing .edit-mode { display: block; }
      .editing .view-mode { display: none; }
    </style>
  </head>
  <body class="p-4">
    <div class="container">
      <h2>Manage Teams and Categories</h2>
      <a href="{{ url_for('dashboard') }}" class="btn btn-secondary mb-3">Back to Dashboard</a>
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, msg in messages %}
            <div class="alert alert-{{ category }}">{{ msg }}</div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <!-- Add Form -->
      <!-- In the form section of categories.html -->
      <form action="{{ url_for('categories') }}" method="post" class="mb-4">
        <div class="form-group">
          <label>Team Type</label>
          <select name="team_type" id="team_type" class="form-control" required>
            <option value="existing" selected>Existing Team</option>
            <option value="new">New Team</option>
          </select>
        </div>
        
        <div id="existing_team" class="form-group">
          <label>Select Team</label>
          <select name="team_name" class="form-control" required>
            {% for team in teams %}
              <option value="{{ team }}">{{ team }}</option>
            {% endfor %}
          </select>
        </div>
        
        <div id="new_team" style="display: none;">
          <div class="form-group">
            <label>New Team Name</label>
            <input name="new_team_name" class="form-control" placeholder="Enter new team name">
          </div>
          <div class="form-group">
            <label>New Team Email</label>
            <input name="new_team_email" class="form-control" placeholder="Enter team email">
          </div>
          <div class="form-group">
            <label>Team Description</label>
            <textarea name="team_description" class="form-control" rows="2" placeholder="Enter team description (used for classification)"></textarea>
          </div>
        </div>
        
        <div class="form-group">
          <label>Category Name</label>
          <input name="category_name" class="form-control" placeholder="Enter category name" required>
        </div>
        
        <div class="form-group">
          <label>Category Description</label>
          <textarea name="category_description" class="form-control" rows="2" placeholder="Enter category description (used for classification)"></textarea>
        </div>
        
        <button type="submit" class="btn btn-success">Add</button>
      </form>

      <!-- Teams Table -->
      <h4>Teams</h4>
      <table class="table table-striped mb-5">
        <thead>
          <tr>
            <th>Team Name</th>
            <th>Email</th>
            <th>Description</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for team in teams %}
            <tr class="team-row" data-team="{{ team }}">
              <td>
                <span class="view-mode">{{ team }}</span>
                <input type="text" class="form-control edit-mode" name="team_name" value="{{ team }}">
              </td>
              <td>
                <span class="view-mode">{{ team_emails[team] }}</span>
                <input type="email" class="form-control edit-mode" name="team_email" value="{{ team_emails[team] }}">
              </td>
              <td>
                <span class="view-mode">{{ team_descriptions[team] }}</span>
                <textarea class="form-control edit-mode" name="team_description" rows="2">{{ team_descriptions[team] }}</textarea>
              </td>
              <td>
                <div class="view-mode">
                  <button class="btn btn-primary btn-sm edit-team-btn">Edit</button>
                </div>
                <div class="edit-mode">
                  <button class="btn btn-success btn-sm save-team-btn">Save</button>
                  <button class="btn btn-secondary btn-sm cancel-team-btn">Cancel</button>
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>

      <!-- Categories Table -->
      <h4>Categories</h4>
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Team</th>
            <th>Category</th>
            <th>Description</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for cat in categories_list %}
            <tr class="category-row" data-catid="{{ cat.id }}">
              <td>{{ cat.team_name }}</td>
              <td>
                <span class="view-mode">{{ cat.category_name }}</span>
                <input type="text" class="form-control edit-mode" name="category_name" value="{{ cat.category_name }}" {% if cat.category_name == 'Other' %}readonly{% endif %}>
              </td>
              <td>
                <span class="view-mode">{{ cat.category_description or '' }}</span>
                <textarea class="form-control edit-mode" name="category_description" rows="2" {% if cat.category_name == 'Other' %}readonly{% endif %}>{{ cat.category_description or '' }}</textarea>
              </td>
              <td>
                <div class="view-mode">
                  {% if cat.category_name != 'Other' %}
                    <button class="btn btn-primary btn-sm edit-cat-btn">Edit</button>
                  {% endif %}
                </div>
                <div class="edit-mode">
                  {% if cat.category_name != 'Other' %}
                    <button class="btn btn-success btn-sm save-cat-btn">Save</button>
                    <button class="btn btn-secondary btn-sm cancel-cat-btn">Cancel</button>
                  {% endif %}
                </div>
                {% if cat.category_name != 'Other' %}
                  <form action="{{ url_for('delete_category', cat_id=cat.id) }}" method="post" style="display:inline;">
                    <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                  </form>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <script>
      $(document).ready(function() {
        // Team type toggle
        $('#team_type').change(function() {
          if ($(this).val() === 'new') {
            $('#existing_team').hide();
            $('#new_team').show();
          } else {
            $('#existing_team').show();
            $('#new_team').hide();
          }
        });

        // Team edit/save functionality
        $('.edit-team-btn').click(function() {
          const row = $(this).closest('.team-row');
          row.addClass('editing');
        });

        $('.cancel-team-btn').click(function() {
          const row = $(this).closest('.team-row');
          row.removeClass('editing');
        });

        $('.save-team-btn').click(function() {
          const row = $(this).closest('.team-row');
          const oldTeamName = row.data('team');
          const teamName = row.find('input[name="team_name"]').val();
          const teamEmail = row.find('input[name="team_email"]').val();
          const teamDescription = row.find('textarea[name="team_description"]').val();

          $.ajax({
            url: '/teams/update/' + encodeURIComponent(oldTeamName),
            method: 'POST',
            data: {
              team_name: teamName,
              team_email: teamEmail,
              team_description: teamDescription
            },
            success: function(response) {
              location.reload(); // Refresh to show changes
            },
            error: function(xhr) {
              alert('Error updating team: ' + xhr.responseText);
            }
          });
        });

        // Category edit/save functionality
        $('.edit-cat-btn').click(function() {
          const row = $(this).closest('.category-row');
          row.addClass('editing');
        });

        $('.cancel-cat-btn').click(function() {
          const row = $(this).closest('.category-row');
          row.removeClass('editing');
        });

        $('.save-cat-btn').click(function() {
          const row = $(this).closest('.category-row');
          const catId = row.data('catid');
          const catName = row.find('input[name="category_name"]').val();
          const catDescription = row.find('textarea[name="category_description"]').val();

          $.ajax({
            url: '/categories/update/' + catId,
            method: 'POST',
            data: {
              category_name: catName,
              category_description: catDescription
            },
            success: function(response) {
              location.reload(); // Refresh to show changes
            },
            error: function(xhr) {
              alert('Error updating category: ' + xhr.responseText);
            }
          });
        });
      });
    </script>
  </body>
</html>